#!/bin/bash

set -e

[ -z "$LIBEXECDIR" ] && LIBEXECDIR="/usr/libexec"
[ -z "$DATADIR" ] && DATADIR="/usr/share"
if [ -z "$LIB" ]; then
  if $(echo nash-showelfinterp /proc/$$/exe | /sbin/nash --forcequiet | grep -q lib64); then
    LIB="lib64"
  else
    LIB="lib"
  fi
fi
[ -z "$LIBDIR" ] && LIBDIR="/usr/$LIB"
[ -z "$BINDIR" ] && BINDIR="/usr/bin"

function usage ()
{
  echo "usage: plymouth-set-default-plugin { --reset | <plugin-name> [ --rebuild-initrd ] }"
}

function get_default_plugin ()
{
        PLUGIN_NAME=$(basename $(readlink ${LIBDIR}/plymouth/default.so) .so)
        if [ -z "$PLUGIN_NAME" ]; then
                $0 --reset
                PLUGIN_NAME=$(basename $(readlink ${LIBDIR}/plymouth/default.so) .so)
        fi
        [ -n "$PLUGIN_NAME" ] && echo $PLUGIN_NAME || exit 1
}

DO_RESET=0
DO_INITRD_REBUILD=0
PLUGIN_NAME=""
while [ $# -gt 0 ]; do
        case "$1" in

        --rebuild-initrd)
                DO_INITRD_REBUILD=1
        ;;

        --reset|default)
                if [ -n "$PLUGIN_NAME" ]; then
                        echo "You can only specify --reset or a plugin name, not both" > /dev/stderr
                        echo $(usage) > /dev/stderr
                        exit 1
                fi

                DO_RESET=1
        ;;

        *)
                if [ -n "$PLUGIN_NAME" ]; then
                        echo "You can only specify one plugin at a time" > /dev/stderr
                        echo $(usage) > /dev/stderr
                        exit 1
                fi

                if [ $DO_RESET -ne 0 ]; then
                        echo "You can only specify --reset or a plugin name, not both" > /dev/stderr
                        echo $(usage) > /dev/stderr
                        exit 1
                fi

                PLUGIN_NAME="$1"
        ;;
  esac
  shift
done

if [ $DO_RESET -eq 0 ] && [ $DO_INITRD_REBUILD -eq 0 ] && [ -z $PLUGIN_NAME ]; then
        get_default_plugin
        exit $?
fi

if [ `id -u` -ne 0 ]; then
        echo "This program must be run as root" > /dev/stderr
        exit 1
fi

if [ $DO_RESET -ne 0 ]; then
        PLUGIN_NAME=$(basename $(ls -1 -t ${LIBDIR}/plymouth/*.so 2> /dev/null | grep -v default.so | tail -n 1) .so)
        if [ $PLUGIN_NAME = .so ]; then
                rm -f ${LIBDIR}/plymouth/default.so
                exit 0
        fi
fi

if [ ! -e ${LIBDIR}/plymouth/${PLUGIN_NAME}.so ]; then
        echo "${LIBDIR}/plymouth/${PLUGIN_NAME}.so does not exist" > /dev/stderr
        exit 1
fi

(cd ${LIBDIR}/plymouth;
        ln -sf ${PLUGIN_NAME}.so default.so && \
        [ $DO_INITRD_REBUILD -ne 0 ] && \
        $LIBEXECDIR/plymouth/plymouth-update-initrd)

